# 判断保留項目（レビュー必要）

デバッグ中に発見された、修正すべきか判断が難しい項目のリスト。
将来のリファクタリングやプロダクト要件の明確化時に検討してください。

## バックエンド

### 1. 非原子的なファイル書き込み
- **ファイル**: `src/html_tool_manager/api/tools.py:123`
- **カテゴリ**: 品質
- **問題**: ツール更新時のファイル書き込みが非原子的。書き込み中に障害が発生するとファイルが破損したまま残る可能性あり。
- **推奨**: 一時ファイルに書き込み、成功後に `os.replace()` で原子的にリネーム。
- **優先度**: 低（発生確率は低いが、発生時の影響は大きい）

### 2. パス検証のプラットフォーム依存性
- **ファイル**: `src/html_tool_manager/api/tools.py:117`
- **カテゴリ**: セキュリティ/品質
- **問題**: `os.sep` を使ったパス検証がWindowsでは不完全（`/`も有効なセパレータ）。
- **推奨**: `os.path.commonpath()` を使用した検証に変更。
- **優先度**: 低（Linuxサーバーで運用する場合は問題なし）

### 3. TOCTOU攻撃の可能性
- **ファイル**: `src/html_tool_manager/api/tools.py:107-121`
- **カテゴリ**: セキュリティ
- **問題**: `os.path.realpath()` でチェックしてから `open()` するまでの間にシンボリックリンクが作成される可能性。
- **推奨**: `os.O_NOFOLLOW` フラグを使用してファイルを開く。
- **優先度**: 低（攻撃に必要な条件が非常に限定的）

### 4. タグの重複チェック
- **ファイル**: `src/html_tool_manager/models/tool.py:64-88`
- **カテゴリ**: データ整合性
- **問題**: タグの重複を許可している（例: `["python", "Python", "python"]`）。
- **推奨**: 重複排除するか、大文字小文字を統一するか要件による。
- **優先度**: 低（UX改善の範疇）

### 5. 検索クエリの最大長制限
- **ファイル**: `src/html_tool_manager/api/tools.py:48`
- **カテゴリ**: DoS対策
- **問題**: 検索クエリ `q` に最大長の制限がない。
- **推奨**: `max_length=500` 程度の制限を追加。
- **優先度**: 低（現状でも処理負荷は限定的）

### 6. offset/limitの組み合わせ制限
- **ファイル**: `src/html_tool_manager/api/tools.py:50-51`
- **カテゴリ**: DoS対策
- **問題**: `offset=999999, limit=1000` のようなクエリでDB負荷が高くなる可能性。
- **推奨**: 合計上限を設けるか、カーソルベースのページネーションに移行。
- **優先度**: 低（大量データが想定されない場合は問題なし）

### 7. 並行更新時の競合制御
- **ファイル**: `src/html_tool_manager/repositories/tool_repository.py:201-214`
- **カテゴリ**: データ整合性
- **問題**: 楽観的ロックや悲観的ロックが実装されていないため、同時更新で後勝ちになる。
- **推奨**: バージョン番号フィールドを追加して楽観的ロックを実装。
- **優先度**: 中（複数ユーザーが同時に編集する場合に問題になる）

### 8. FTS5インデックスの再構築
- **ファイル**: `src/html_tool_manager/core/db.py:11-50`
- **カテゴリ**: メンテナンス性
- **問題**: FTS5インデックスの破損時の復旧方法が不明。
- **推奨**: 管理APIとして `INSERT INTO tool_fts(tool_fts) VALUES('rebuild');` を提供。
- **優先度**: 低（運用要件による）

### 9. エクスポート時のツール順序
- **ファイル**: `src/html_tool_manager/api/tools.py:151-169`
- **カテゴリ**: 機能仕様
- **問題**: `tool_ids` の順序がエクスポートデータに保持されない。
- **推奨**: 要件に応じて順序を保持するか検討。
- **優先度**: 低（UX改善の範疇）

## フロントエンド

### 10. エラーハンドリングの一貫性
- **ファイル**: `static/js/main.js:145-148`, `static/js/main.js:198-212`
- **カテゴリ**: 機能
- **問題**: APIエラー時のエラーメッセージが不十分。HTTPステータスコードに応じた詳細メッセージを表示していない。
- **推奨**: レスポンスからエラー詳細を取得して表示。
- **優先度**: 中（ユーザー体験の改善）

### 11. 削除確認ダイアログのツール名表示
- **ファイル**: `static/js/main.js:193`
- **カテゴリ**: 品質
- **問題**: 削除確認で `toolId` を表示しているが、ツール名の方がユーザーフレンドリー。
- **推奨**: DOMからツール名を取得して表示。
- **優先度**: 低（UX改善の範疇）

### 12. Ace Editor同期のパフォーマンス
- **ファイル**: `static/js/editor.js:105-107`
- **カテゴリ**: 品質
- **問題**: 大きなファイル編集時に `change` イベントごとの同期でパフォーマンス問題が発生する可能性。
- **推奨**: デバウンス処理を追加（ただしフォーム送信時の同期を確認）。
- **優先度**: 低（現状で問題が報告されていなければ）

### 13. iframe sandboxの設定
- **ファイル**: `templates/tool_viewer.html:95`
- **カテゴリ**: セキュリティ/機能
- **問題**: sandbox属性が `allow-scripts` のみで、`localStorage` 等を使用するツールが動作しない可能性。
- **推奨**: 要件に応じて `allow-forms`, `allow-popups` 等を追加検討。
- **優先度**: 中（ツールの機能要件による）

### 14. フォームリセット時のAce Editorクリア
- **ファイル**: `templates/create.html:165`
- **カテゴリ**: 機能
- **問題**: `form.reset()` ではAce Editorの内容がリセットされない。
- **推奨**: Ace Editorの `setValue('', -1)` を明示的に呼び出す。
- **優先度**: 低（新規作成後にフォームをリセットするユースケースが限定的）

### 15. アクセシビリティ属性の追加
- **ファイル**: `templates/index.html:43`
- **カテゴリ**: 品質
- **問題**: チェックボックスヘッダーに `aria-label` がない。
- **推奨**: `aria-label="すべてのツールを選択"` を追加。
- **優先度**: 低（アクセシビリティ要件による）

---

## 修正済み項目（参考）

今回のデバッグで修正済みの項目：

1. **[高]** React template XSS (`</script>` エスケープ)
2. **[高]** main.js innerHTML XSS
3. **[中]** updated_at 自動更新
4. **[中]** インポート時DoS対策
5. **[中]** エンコーディング指定追加
6. **[中]** TemplateResponse非推奨警告修正
