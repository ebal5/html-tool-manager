{% extends 'base.html' %}

{% block title %}Edit Tool - HTML Tool Manager{% endblock %}

{% block content %}
    <style>
        .edit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .edit-header h2 {
            margin-bottom: 0;
        }
    </style>

    <article>
        <header class="edit-header">
            <h2>ツール編集 (ID: {{ tool_id }})</h2>
            <a href="/tools/view/{{ tool_id }}" role="button" class="secondary outline">表示</a>
        </header>

        <form id="edit-tool-form">
            <label for="name">ツール名</label>
            <input type="text" id="name" name="name" placeholder="すごいツール" required>

            <label for="description">説明</label>
            <textarea id="description" name="description" placeholder="このツールの説明"></textarea>

            <label for="tags">タグ</label>
            <input type="text" id="tags" name="tags" placeholder="計算, テキスト, ユーティリティ">
            <small>カンマ区切りで入力</small>

            <div id="source-section">
                <!-- Content will be loaded here by JavaScript -->
            </div>
            
            <button type="submit" id="submit-btn">更新</button>
        </form>
        <p id="message" style="margin-top: 1rem;"></p>
    </article>

    <script>
        const toolId = {{ tool_id }};
        const form = document.getElementById('edit-tool-form');
        const nameInput = document.getElementById('name');
        const descriptionInput = document.getElementById('description');
        const tagsInput = document.getElementById('tags');
        const sourceSection = document.getElementById('source-section');
        const messageDiv = document.getElementById('message');
        const submitBtn = document.getElementById('submit-btn');

        let originalFilepath = '';
        let isPastedContent = false;

        async function loadToolData() {
            try {
                const response = await fetch(`/api/tools/${toolId}`);
                if (!response.ok) throw new Error('Tool not found');
                const tool = await response.json();

                nameInput.value = tool.name;
                descriptionInput.value = tool.description || '';
                tagsInput.value = tool.tags.join(', ');
                originalFilepath = tool.filepath;

                // Check if the tool was created by pasting content
                isPastedContent = originalFilepath.startsWith('static/tools/');
                
                if (isPastedContent) {
                    // Fetch the HTML content and display a textarea safely
                    sourceSection.innerHTML = '<p aria-busy="true">Loading content...</p>';
                    const htmlResponse = await fetch(`/${originalFilepath}`);
                    const htmlContent = await htmlResponse.text();
                    
                    sourceSection.innerHTML = ''; // Clear loading message
                    const label = document.createElement('label');
                    label.setAttribute('for', 'html_content');
                    label.textContent = 'HTMLコンテンツ';

                    const textarea = document.createElement('textarea');
                    textarea.id = 'html_content';
                    textarea.name = 'html_content';
                    textarea.rows = 10;
                    textarea.value = htmlContent; // Use .value to set content safely

                    sourceSection.appendChild(label);
                    sourceSection.appendChild(textarea);
                } else {
                    // Display a read-only filepath
                    sourceSection.innerHTML = `
                        <label>ファイルパス</label>
                        <input type="text" id="filepath" name="filepath" value="${originalFilepath}" readonly>
                    `;
                }

            } catch (error) {
                messageDiv.textContent = `エラー: ツールデータの読み込みに失敗しました - ${error.message}`;
                messageDiv.style.color = 'var(--pico-color-red-500)';
                form.style.display = 'none';
            }
        }

        form.addEventListener('submit', async function(event) {
            event.preventDefault();
            submitBtn.setAttribute('aria-busy', 'true');

            const updatedData = {
                name: nameInput.value,
                description: descriptionInput.value,
                tags: tagsInput.value.split(',').map(tag => tag.trim()).filter(tag => tag !== ''),
                filepath: originalFilepath // Always send the original filepath
            };

            // If it was a pasted tool, include the updated HTML content
            if (isPastedContent) {
                updatedData.html_content = document.getElementById('html_content').value;
            }

            const response = await fetch(`/api/tools/${toolId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updatedData)
            });

            if (response.ok) {
                const updatedTool = await response.json();
                messageDiv.innerHTML = `ツール「<strong>${updatedTool.name}</strong>」を更新しました。<a href="/tools/view/${toolId}">表示</a> | <a href="/">一覧に戻る</a>`;
                messageDiv.style.color = 'var(--pico-color-green-500)';
            } else {
                const errorData = await response.json();
                messageDiv.textContent = `エラー: ${errorData.detail || '不明なエラーが発生しました'}`;
                messageDiv.style.color = 'var(--pico-color-red-500)';
            }
            submitBtn.removeAttribute('aria-busy');
        });

        loadToolData();
    </script>
{% endblock %}
