{% extends 'base.html' %}

{% block title %}Edit Tool - HTML Tool Manager{% endblock %}

{% block content %}
    <!-- Ace Editor CDN -->
    <script src="https://cdn.jsdelivr.net/npm/ace-builds@1.32.6/src-min-noconflict/ace.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ace-builds@1.32.6/src-min-noconflict/mode-html.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ace-builds@1.32.6/src-min-noconflict/mode-jsx.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ace-builds@1.32.6/src-min-noconflict/theme-monokai.min.js"></script>

    <style>
        .edit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .edit-header h2 {
            margin-bottom: 0;
        }
    </style>

    <article>
        <header class="edit-header">
            <h2>ツール編集 (ID: {{ tool_id }})</h2>
            <a href="/tools/view/{{ tool_id }}" role="button" class="secondary outline">表示</a>
        </header>

        <!-- タブナビゲーション -->
        <nav class="tab-navigation">
            <button type="button" class="tab-btn active" data-tab="edit">編集</button>
            <button type="button" class="tab-btn" data-tab="history">履歴</button>
        </nav>

        <!-- 編集タブ -->
        <div id="edit-tab" class="tab-content">
        <form id="edit-tool-form">
            <label for="name">ツール名 <small>(1-100文字)</small></label>
            <input type="text" id="name" name="name" placeholder="すごいツール" required maxlength="100">

            <label for="description">説明 <small>(最大1000文字)</small></label>
            <textarea id="description" name="description" placeholder="このツールの説明" maxlength="1000"></textarea>

            <label for="tags">タグ <small>(最大20個、各1-50文字)</small></label>
            <input type="text" id="tags" name="tags" placeholder="計算, テキスト, ユーティリティ">
            <small>カンマ区切りで入力</small>

            <label for="tool_type">ツールタイプ</label>
            <select id="tool_type" name="tool_type">
                <option value="html">HTML</option>
                <option value="react">React (JSX)</option>
            </select>

            <div id="source-section">
                <!-- Content will be loaded here by JavaScript -->
            </div>

            <button type="submit" id="submit-btn">更新</button>
        </form>
        <p id="message" style="margin-top: 1rem;"></p>
        </div>

        <!-- 履歴タブ -->
        <div id="history-tab" class="tab-content hidden">
            <div id="snapshot-list-container">
                <p>履歴タブを選択すると履歴を読み込みます。</p>
            </div>
            <div id="diff-viewer" class="hidden">
                <!-- diff2html が出力する差分表示エリア -->
            </div>
            <button type="button" id="close-diff-btn" class="hidden secondary outline" style="margin-top: 1rem;">差分を閉じる</button>
        </div>
    </article>

    <script src="/static/js/validation.js"></script>
    <script src="/static/js/editor.js"></script>
    <script src="/static/js/tag-autocomplete.js"></script>
    <script src="/static/js/snapshot.js"></script>
    <script>
        // タグオートコンプリートを設定
        setupTagAutocomplete(document.getElementById('tags'), 'tag-suggestions-edit');

        const toolId = {{ tool_id }};
        const form = document.getElementById('edit-tool-form');
        const nameInput = document.getElementById('name');
        const descriptionInput = document.getElementById('description');
        const tagsInput = document.getElementById('tags');
        const toolTypeSelect = document.getElementById('tool_type');
        const sourceSection = document.getElementById('source-section');
        const messageDiv = document.getElementById('message');
        const submitBtn = document.getElementById('submit-btn');

        let originalFilepath = '';
        let isPastedContent = false;
        let codeEditor = null;

        // filepathからツールURLを生成（最後の2セグメント: {uuid}/index.html）
        function getToolUrl(filepath) {
            if (!filepath) return null;
            const segments = filepath.split('/');
            if (segments.length < 2) return null;
            const relativePath = segments.slice(-2).join('/');
            return '/tool-files/' + relativePath;
        }

        // エラーメッセージを安全に表示するヘルパー関数
        function showError(errorText) {
            messageDiv.innerHTML = '';
            messageDiv.textContent = 'エラー: ' + errorText;
            messageDiv.style.color = 'var(--pico-color-red-500)';
        }

        // リアルタイムバリデーションの設定
        setupRealtimeValidation(nameInput, validateName);
        setupRealtimeValidation(descriptionInput, validateDescription);
        setupRealtimeValidation(tagsInput, validateTags);

        // ツールタイプ変更時にエディタモードを切り替え
        toolTypeSelect.addEventListener('change', function(e) {
            setEditorMode(codeEditor, e.target.value);
        });

        async function loadToolData() {
            try {
                const response = await fetch('/api/tools/' + toolId);
                if (!response.ok) throw new Error('ツールが見つかりません');
                const tool = await response.json();

                nameInput.value = tool.name;
                descriptionInput.value = tool.description || '';
                tagsInput.value = tool.tags.join(', ');
                toolTypeSelect.value = tool.tool_type || 'html';
                originalFilepath = tool.filepath;

                // filepathが存在すれば編集可能なコンテンツとみなす
                const toolUrl = getToolUrl(originalFilepath);
                isPastedContent = !!toolUrl;

                if (isPastedContent) {
                    // Fetch the HTML content and display a textarea safely
                    sourceSection.innerHTML = '<p aria-busy="true">コンテンツを読み込み中...</p>';
                    const htmlResponse = await fetch(toolUrl);
                    if (!htmlResponse.ok) throw new Error('HTMLコンテンツの読み込みに失敗しました');
                    const htmlContent = await htmlResponse.text();

                    sourceSection.innerHTML = ''; // Clear loading message
                    const label = document.createElement('label');
                    label.setAttribute('for', 'html_content');
                    label.textContent = 'HTMLコンテンツ';

                    const textarea = document.createElement('textarea');
                    textarea.id = 'html_content';
                    textarea.name = 'html_content';
                    textarea.rows = 10;
                    textarea.value = htmlContent; // Use .value to set content safely

                    sourceSection.appendChild(label);
                    sourceSection.appendChild(textarea);

                    // Ace Editorを初期化（ツールタイプに応じたモードで）
                    function initEditorWithRetry(retries = 0) {
                        if (typeof ace === 'undefined') {
                            if (retries < ACE_LOAD_MAX_RETRIES) {
                                setTimeout(() => initEditorWithRetry(retries + 1), ACE_LOAD_RETRY_INTERVAL_MS);
                            } else {
                                console.error('Ace Editor failed to load after maximum retries');
                            }
                            return;
                        }
                        codeEditor = initializeAceEditor('html_content', 'code-editor-edit', tool.tool_type);
                    }
                    initEditorWithRetry();
                } else {
                    // Display a read-only filepath (XSS対策: DOM APIで構築)
                    sourceSection.innerHTML = '';
                    const label = document.createElement('label');
                    label.textContent = 'ファイルパス';
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.id = 'filepath';
                    input.name = 'filepath';
                    input.value = originalFilepath;
                    input.readOnly = true;
                    sourceSection.appendChild(label);
                    sourceSection.appendChild(input);
                }

            } catch (error) {
                showError('ツールデータの読み込みに失敗しました');
                console.error('Error loading tool data:', error);
                form.style.display = 'none';
            }
        }

        form.addEventListener('submit', async function(event) {
            event.preventDefault();

            // フォームデータの収集
            const formData = {
                name: nameInput.value,
                description: descriptionInput.value,
                tags: tagsInput.value,
                tool_type: toolTypeSelect.value,
                html_content: isPastedContent ? document.getElementById('html_content').value : null
            };

            // クライアント側バリデーション
            const validation = validateToolForm(formData);
            if (!validation.valid) {
                showValidationErrors(messageDiv, validation.errors);
                return;
            }

            submitBtn.setAttribute('aria-busy', 'true');

            const updatedData = {
                name: validation.data.name,
                description: validation.data.description,
                tags: validation.data.tags,
                tool_type: validation.data.tool_type,
                filepath: originalFilepath
            };

            // If it was a pasted tool, include the updated HTML content
            if (isPastedContent) {
                updatedData.html_content = validation.data.html_content;
            }

            try {
                const response = await fetch('/api/tools/' + toolId, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedData)
                });

                if (response.ok) {
                    const updatedTool = await response.json();
                    // XSS対策: DOM APIで安全に構築
                    messageDiv.innerHTML = '';
                    messageDiv.appendChild(document.createTextNode('ツール「'));
                    const strong = document.createElement('strong');
                    strong.textContent = updatedTool.name;
                    messageDiv.appendChild(strong);
                    messageDiv.appendChild(document.createTextNode('」を更新しました。'));
                    const viewLink = document.createElement('a');
                    viewLink.href = '/tools/view/' + toolId;
                    viewLink.textContent = '表示';
                    messageDiv.appendChild(viewLink);
                    messageDiv.appendChild(document.createTextNode(' | '));
                    const homeLink = document.createElement('a');
                    homeLink.href = '/';
                    homeLink.textContent = '一覧に戻る';
                    messageDiv.appendChild(homeLink);
                    messageDiv.style.color = 'var(--pico-color-green-500)';
                } else {
                    const errorData = await response.json();
                    showError(errorData.detail || '不明なエラーが発生しました');
                }
            } catch (error) {
                showError('ネットワークエラーが発生しました');
                console.error('Error updating tool:', error);
            } finally {
                submitBtn.removeAttribute('aria-busy');
            }
        });

        loadToolData();

        // タブ切り替えロジック
        let historyLoaded = false;
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const tabId = this.dataset.tab;

                // タブボタンのアクティブ状態を切り替え
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');

                // タブコンテンツの表示を切り替え
                document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                document.getElementById(tabId + '-tab').classList.remove('hidden');

                // 履歴タブを初めて開いた時にスナップショットを読み込む
                if (tabId === 'history' && !historyLoaded) {
                    fetchSnapshots(toolId, document.getElementById('snapshot-list-container'));
                    historyLoaded = true;
                }
            });
        });

        // 差分を閉じるボタン
        document.getElementById('close-diff-btn').addEventListener('click', function() {
            closeDiffViewer();
            this.classList.add('hidden');
        });

        // 差分表示時にボタンを表示する監視
        const diffViewer = document.getElementById('diff-viewer');
        const closeDiffBtn = document.getElementById('close-diff-btn');
        const observer = new MutationObserver(function(mutations) {
            if (!diffViewer.classList.contains('hidden') && diffViewer.innerHTML.trim() !== '') {
                closeDiffBtn.classList.remove('hidden');
            }
        });
        observer.observe(diffViewer, { childList: true, subtree: true });
    </script>
{% endblock %}
