{% extends 'base.html' %}

{% block title %}View Tool - HTML Tool Manager{% endblock %}

{% block content %}
    <style>
        /* ツール表示ページは幅を広げる */
        .tool-viewer-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        .tool-viewer-header .tool-info {
            flex: 1;
        }
        .tool-viewer-header .tool-actions {
            flex-shrink: 0;
            margin-left: 1rem;
        }
        #tool-content {
            margin-left: -5%;
            margin-right: -5%;
            padding: 0 1rem;
        }
        #tool-content iframe {
            width: 100%;
            height: 80vh;
            border: 1px solid var(--pico-muted-border-color);
        }
    </style>

    <div class="tool-viewer-header">
        <div class="tool-info">
            <h2 id="tool-name">読み込み中...</h2>
            <p id="tool-description"></p>
            <div id="tool-tags"></div>
        </div>
        <div class="tool-actions">
            <button type="button" id="fork-btn" class="secondary outline">フォーク</button>
            <a href="/tools/edit/{{ tool_id }}" role="button" class="secondary outline">編集</a>
        </div>
    </div>

    <div id="tool-content">
        <p aria-busy="true">ツールを読み込み中...</p>
    </div>

    <script src="/static/js/validation.js"></script>
    <script>
        const toolId = {{ tool_id }};
        const toolNameEl = document.getElementById('tool-name');
        const toolDescriptionEl = document.getElementById('tool-description');
        const toolTagsEl = document.getElementById('tool-tags');
        const toolContentEl = document.getElementById('tool-content');

        // filepathからツールURLを生成（最後の2セグメント: {uuid}/index.html）
        function getToolUrl(filepath) {
            if (!filepath) return null;
            const segments = filepath.split('/');
            if (segments.length < 2) return null;
            const relativePath = segments.slice(-2).join('/');
            return '/tools/' + relativePath;
        }

        // エラーメッセージを安全に表示するヘルパー関数
        function showError(message) {
            toolContentEl.innerHTML = '';
            const p = document.createElement('p');
            p.style.color = 'var(--pico-color-red-500)';
            p.textContent = message;
            toolContentEl.appendChild(p);
        }

        async function fetchToolDetails() {
            try {
                const response = await fetch('/api/tools/' + toolId);
                if (!response.ok) {
                    throw new Error('ツールが見つかりません');
                }
                const tool = await response.json();

                toolNameEl.textContent = tool.name;
                toolDescriptionEl.textContent = tool.description || '';

                // Safely create and append tags
                toolTagsEl.innerHTML = ''; // Clear previous tags
                if (tool.tags && tool.tags.length > 0) {
                    tool.tags.forEach((tag, index) => {
                        const code = document.createElement('code');
                        code.textContent = tag;
                        toolTagsEl.appendChild(code);
                        if (index < tool.tags.length - 1) {
                            toolTagsEl.appendChild(document.createTextNode(' '));
                        }
                    });
                }

                // ここでツール本体をロードする
                const toolUrl = getToolUrl(tool.filepath);
                if (toolUrl) {
                    toolContentEl.innerHTML = '';
                    const iframe = document.createElement('iframe');
                    // セキュリティ: allow-scripts のみ設定
                    // allow-same-origin は同一オリジンでサンドボックスをバイパス可能なため除外
                    iframe.setAttribute('sandbox', 'allow-scripts');
                    iframe.src = toolUrl;
                    iframe.title = tool.name; // アクセシビリティ: スクリーンリーダー用
                    toolContentEl.appendChild(iframe);
                } else {
                    showError('このツールは表示できません。ファイルパスが無効です。');
                }

            } catch (error) {
                showError('ツールの読み込みに失敗しました。');
                console.error('Error fetching tool details:', error);
            }
        }

        fetchToolDetails();

        // フォーク機能
        const forkBtn = document.getElementById('fork-btn');
        const forkModal = document.getElementById('fork-modal');
        const forkForm = document.getElementById('fork-form');
        const forkNameInput = document.getElementById('fork-name');
        const forkSubmitBtn = document.getElementById('fork-submit-btn');
        const forkCancelBtn = document.getElementById('fork-cancel-btn');
        const forkCloseBtn = document.getElementById('fork-modal-close');
        const forkMessage = document.getElementById('fork-message');

        // maxlengthを定数から動的に設定（DRY原則: validation.jsのValidationRulesを使用）
        forkNameInput.setAttribute('maxlength', ValidationRules.NAME_MAX_LENGTH);
        document.getElementById('fork-name-hint').textContent =
            `最大${ValidationRules.NAME_MAX_LENGTH}文字。空のままで確定すると自動で名前が付けられます。`;

        // リアルタイムバリデーションを設定（空の場合はバリデーションをスキップ）
        forkNameInput.addEventListener('blur', function() {
            if (this.value.trim()) {
                const result = validateName(this.value);
                if (!result.valid) {
                    this.setAttribute('aria-invalid', 'true');
                } else {
                    this.removeAttribute('aria-invalid');
                }
            } else {
                this.removeAttribute('aria-invalid');
            }
        });
        forkNameInput.addEventListener('input', function() {
            this.removeAttribute('aria-invalid');
        });

        // モーダルを開く
        forkBtn.addEventListener('click', function() {
            forkNameInput.value = '';
            forkNameInput.removeAttribute('aria-invalid');
            forkMessage.textContent = '';
            forkMessage.style.color = '';
            forkModal.showModal();
        });

        // モーダルを閉じる
        function closeForkModal() {
            forkModal.close();
        }
        forkCancelBtn.addEventListener('click', closeForkModal);
        forkCloseBtn.addEventListener('click', closeForkModal);

        // 背景クリックで閉じる
        forkModal.addEventListener('click', function(e) {
            if (e.target === forkModal) {
                closeForkModal();
            }
        });

        // フォーム送信
        forkForm.addEventListener('submit', async function(event) {
            event.preventDefault();

            forkSubmitBtn.setAttribute('aria-busy', 'true');
            forkMessage.textContent = '';

            const forkName = forkNameInput.value.trim();

            // クライアントサイドバリデーション（空の場合はスキップ - サーバーでデフォルト名が使用される）
            if (forkName) {
                const nameResult = validateName(forkName);
                if (!nameResult.valid) {
                    forkMessage.textContent = nameResult.error;
                    forkMessage.style.color = 'var(--pico-color-red-500)';
                    forkNameInput.setAttribute('aria-invalid', 'true');
                    forkSubmitBtn.removeAttribute('aria-busy');
                    return;
                }
            }

            try {
                const response = await fetch('/api/tools/' + toolId + '/fork', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: forkName || null })
                });

                if (response.ok) {
                    const forkedTool = await response.json();
                    window.location.href = '/tools/view/' + forkedTool.id;
                } else {
                    const errorData = await response.json();
                    forkMessage.textContent = 'エラー: ' + (errorData.detail || '不明なエラーが発生しました');
                    forkMessage.style.color = 'var(--pico-color-red-500)';
                }
            } catch (error) {
                forkMessage.textContent = 'エラー: ネットワークエラーが発生しました';
                forkMessage.style.color = 'var(--pico-color-red-500)';
                console.error('Error forking tool:', error);
            } finally {
                forkSubmitBtn.removeAttribute('aria-busy');
            }
        });
    </script>

    <!-- フォークモーダル -->
    <dialog id="fork-modal" aria-labelledby="fork-modal-title">
        <article>
            <header>
                <button type="button" aria-label="閉じる" rel="prev" id="fork-modal-close"></button>
                <h3 id="fork-modal-title">ツールをフォーク</h3>
            </header>
            <form id="fork-form">
                <label for="fork-name">新しいツール名</label>
                <input type="text" id="fork-name" name="fork-name"
                       placeholder="空の場合は「元の名前 (Fork)」になります">
                <small id="fork-name-hint">空のままで確定すると自動で名前が付けられます。</small>
            </form>
            <footer>
                <button type="button" id="fork-cancel-btn" class="secondary">キャンセル</button>
                <button type="submit" id="fork-submit-btn" form="fork-form">フォークを作成</button>
            </footer>
            <p id="fork-message" style="margin-top: 1rem;"></p>
        </article>
    </dialog>
{% endblock %}