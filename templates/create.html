{% extends 'base.html' %}

{% block title %}Create New Tool - HTML Tool Manager{% endblock %}

{% block content %}
    <article>
        <header>
            <h2>新規ツール作成</h2>
        </header>

        <form id="create-tool-form">
            <label for="name">ツール名 <small>(1-100文字)</small></label>
            <input type="text" id="name" name="name" placeholder="すごいツール" required maxlength="100">

            <label for="description">説明 <small>(最大1000文字)</small></label>
            <textarea id="description" name="description" placeholder="このツールの説明" maxlength="1000"></textarea>

            <label for="tags">タグ <small>(最大20個、各1-50文字)</small></label>
            <input type="text" id="tags" name="tags" placeholder="計算, テキスト, ユーティリティ">
            <small>カンマ区切りで入力</small>

            <label for="html_content">HTMLコンテンツ</label>
            <textarea id="html_content" name="html_content" rows="10" placeholder="<!DOCTYPE html>..." required></textarea>

            <button type="submit" id="submit-btn">作成</button>
        </form>
        <p id="message" style="margin-top: 1rem;"></p>
    </article>

    <script src="/static/js/validation.js"></script>
    <script>
        // エラーメッセージを安全に表示するヘルパー関数
        function showError(messageDiv, errorText) {
            messageDiv.innerHTML = '';
            messageDiv.textContent = 'エラー: ' + errorText;
            messageDiv.style.color = 'var(--pico-color-red-500)';
        }

        // リアルタイムバリデーションの設定
        setupRealtimeValidation(document.getElementById('name'), validateName);
        setupRealtimeValidation(document.getElementById('description'), validateDescription);
        setupRealtimeValidation(document.getElementById('tags'), validateTags);

        // Form submission logic
        document.getElementById('create-tool-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            const submitBtn = document.getElementById('submit-btn');
            const messageDiv = document.getElementById('message');

            // フォームデータの収集
            const formData = {
                name: document.getElementById('name').value,
                description: document.getElementById('description').value,
                tags: document.getElementById('tags').value,
                html_content: document.getElementById('html_content').value
            };

            // クライアント側バリデーション
            const validation = validateToolForm(formData);
            if (!validation.valid) {
                showValidationErrors(messageDiv, validation.errors);
                return;
            }

            submitBtn.setAttribute('aria-busy', 'true');

            try {
                const response = await fetch('/api/tools/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(validation.data)
                });

                if (response.ok) {
                    const newTool = await response.json();
                    // XSS対策: DOM APIで安全に構築
                    messageDiv.innerHTML = '';
                    messageDiv.appendChild(document.createTextNode('ツール「'));
                    const strong = document.createElement('strong');
                    strong.textContent = newTool.name;
                    messageDiv.appendChild(strong);
                    messageDiv.appendChild(document.createTextNode('」を作成しました。'));
                    const viewLink = document.createElement('a');
                    viewLink.href = '/tools/view/' + newTool.id;
                    viewLink.textContent = '表示';
                    messageDiv.appendChild(viewLink);
                    messageDiv.appendChild(document.createTextNode(' | '));
                    const homeLink = document.createElement('a');
                    homeLink.href = '/';
                    homeLink.textContent = '一覧に戻る';
                    messageDiv.appendChild(homeLink);
                    messageDiv.style.color = 'var(--pico-color-green-500)';
                    document.getElementById('create-tool-form').reset();
                } else {
                    const errorData = await response.json();
                    showError(messageDiv, errorData.detail || '不明なエラーが発生しました');
                }
            } catch (error) {
                showError(messageDiv, 'ネットワークエラーが発生しました');
                console.error('Error creating tool:', error);
            } finally {
                submitBtn.removeAttribute('aria-busy');
            }
        });
    </script>
{% endblock %}
