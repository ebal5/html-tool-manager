{% extends 'base.html' %}

{% block title %}Create New Tool - HTML Tool Manager{% endblock %}

{% block content %}
    <!-- Ace Editor CDN -->
    <script src="https://cdn.jsdelivr.net/npm/ace-builds@1.32.6/src-min-noconflict/ace.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ace-builds@1.32.6/src-min-noconflict/mode-html.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ace-builds@1.32.6/src-min-noconflict/mode-jsx.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ace-builds@1.32.6/src-min-noconflict/theme-monokai.min.js"></script>

    <article>
        <header>
            <h2>æ–°è¦ãƒ„ãƒ¼ãƒ«ä½œæˆ</h2>
        </header>

        <form id="create-tool-form">
            <label for="name">ãƒ„ãƒ¼ãƒ«å <small>(1-100æ–‡å­—)</small></label>
            <input type="text" id="name" name="name" placeholder="ã™ã”ã„ãƒ„ãƒ¼ãƒ«" required maxlength="100">

            <label for="description">èª¬æ˜ <small>(æœ€å¤§1000æ–‡å­—)</small></label>
            <textarea id="description" name="description" placeholder="ã“ã®ãƒ„ãƒ¼ãƒ«ã®èª¬æ˜" maxlength="1000"></textarea>

            <label for="tags">ã‚¿ã‚° <small>(æœ€å¤§20å€‹ã€å„1-50æ–‡å­—)</small></label>
            <input type="text" id="tags" name="tags" placeholder="è¨ˆç®—, ãƒ†ã‚­ã‚¹ãƒˆ, ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£">
            <small>ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§å…¥åŠ›</small>

            <label for="tool_type">ãƒ„ãƒ¼ãƒ«ã‚¿ã‚¤ãƒ—</label>
            <select id="tool_type" name="tool_type">
                <option value="">è‡ªå‹•æ¤œå‡º</option>
                <option value="html">HTML</option>
                <option value="react">React (JSX)</option>
            </select>
            <small>ã€Œè‡ªå‹•æ¤œå‡ºã€ã‚’é¸æŠã™ã‚‹ã¨ã€ã‚³ãƒ¼ãƒ‰ã‚’è§£æã—ã¦é©åˆ‡ãªã‚¿ã‚¤ãƒ—ã‚’åˆ¤å®šã—ã¾ã™</small>

            <label for="html_content">ã‚³ãƒ¼ãƒ‰</label>
            <textarea id="html_content" name="html_content" rows="15" placeholder="HTMLã‚³ãƒ¼ãƒ‰ã¾ãŸã¯JSXã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šä»˜ã‘..." required></textarea>
            <small>ğŸ’¡ Claude Artifacts ã‚„ Gemini Canvas ã§ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã‚’ãã®ã¾ã¾è²¼ã‚Šä»˜ã‘ã§ãã¾ã™</small>

            <button type="submit" id="submit-btn">ä½œæˆ</button>
        </form>
        <p id="message" style="margin-top: 1rem;"></p>
    </article>

    <script src="/static/js/validation.js"></script>
    <script src="/static/js/editor.js"></script>
    <script>
        // Ace Editorã‚’åˆæœŸåŒ–
        let codeEditor = null;
        function initEditor() {
            codeEditor = initializeAceEditor('html_content', 'code-editor');
        }
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initEditor);
        } else {
            initEditor();
        }

        // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å®‰å…¨ã«è¡¨ç¤ºã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function showError(messageDiv, errorText) {
            messageDiv.innerHTML = '';
            messageDiv.textContent = 'ã‚¨ãƒ©ãƒ¼: ' + errorText;
            messageDiv.style.color = 'var(--pico-color-red-500)';
        }

        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®è¨­å®š
        setupRealtimeValidation(document.getElementById('name'), validateName);
        setupRealtimeValidation(document.getElementById('description'), validateDescription);
        setupRealtimeValidation(document.getElementById('tags'), validateTags);

        // ãƒ„ãƒ¼ãƒ«ã‚¿ã‚¤ãƒ—å¤‰æ›´æ™‚ã«ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¢ãƒ¼ãƒ‰ã‚’åˆ‡ã‚Šæ›¿ãˆ
        document.getElementById('tool_type').addEventListener('change', function(e) {
            setEditorMode(codeEditor, e.target.value);
        });

        // Form submission logic
        document.getElementById('create-tool-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            const submitBtn = document.getElementById('submit-btn');
            const messageDiv = document.getElementById('message');

            // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã®åé›†
            const toolTypeValue = document.getElementById('tool_type').value;
            const formData = {
                name: document.getElementById('name').value,
                description: document.getElementById('description').value,
                tags: document.getElementById('tags').value,
                html_content: document.getElementById('html_content').value,
                tool_type: toolTypeValue || null  // ç©ºæ–‡å­—åˆ—ã®å ´åˆã¯ nullï¼ˆè‡ªå‹•æ¤œå‡ºï¼‰
            };

            // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            const validation = validateToolForm(formData);
            if (!validation.valid) {
                showValidationErrors(messageDiv, validation.errors);
                return;
            }

            submitBtn.setAttribute('aria-busy', 'true');

            try {
                const response = await fetch('/api/tools/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(validation.data)
                });

                if (response.ok) {
                    const newTool = await response.json();
                    // XSSå¯¾ç­–: DOM APIã§å®‰å…¨ã«æ§‹ç¯‰
                    messageDiv.innerHTML = '';
                    messageDiv.appendChild(document.createTextNode('ãƒ„ãƒ¼ãƒ«ã€Œ'));
                    const strong = document.createElement('strong');
                    strong.textContent = newTool.name;
                    messageDiv.appendChild(strong);
                    messageDiv.appendChild(document.createTextNode('ã€ã‚’'));

                    // è‡ªå‹•æ¤œå‡ºçµæœã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡¨ç¤º
                    const wasAutoDetected = !validation.data.tool_type || validation.data.tool_type === '';
                    if (wasAutoDetected && newTool.tool_type) {
                        const typeBadge = document.createElement('code');
                        typeBadge.textContent = newTool.tool_type === 'react' ? 'React' : 'HTML';
                        typeBadge.style.padding = '0.25rem 0.5rem';
                        typeBadge.style.borderRadius = '0.25rem';
                        typeBadge.style.fontSize = '0.875rem';
                        if (newTool.tool_type === 'react') {
                            typeBadge.style.backgroundColor = '#61DAFB';
                            typeBadge.style.color = '#000';
                            typeBadge.setAttribute('aria-label', 'ãƒ„ãƒ¼ãƒ«ã‚¿ã‚¤ãƒ—: React');
                        } else {
                            typeBadge.style.backgroundColor = '#E34C26';
                            typeBadge.style.color = '#fff';
                            typeBadge.setAttribute('aria-label', 'ãƒ„ãƒ¼ãƒ«ã‚¿ã‚¤ãƒ—: HTML');
                        }
                        messageDiv.appendChild(typeBadge);
                        messageDiv.appendChild(document.createTextNode('ã¨ã—ã¦'));
                    }

                    messageDiv.appendChild(document.createTextNode('ä½œæˆã—ã¾ã—ãŸã€‚'));
                    const viewLink = document.createElement('a');
                    viewLink.href = '/tools/view/' + newTool.id;
                    viewLink.textContent = 'è¡¨ç¤º';
                    messageDiv.appendChild(viewLink);
                    messageDiv.appendChild(document.createTextNode(' | '));
                    const homeLink = document.createElement('a');
                    homeLink.href = '/';
                    homeLink.textContent = 'ä¸€è¦§ã«æˆ»ã‚‹';
                    messageDiv.appendChild(homeLink);
                    messageDiv.style.color = 'var(--pico-color-green-500)';
                    document.getElementById('create-tool-form').reset();
                } else {
                    const errorData = await response.json();
                    showError(messageDiv, errorData.detail || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                }
            } catch (error) {
                showError(messageDiv, 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                console.error('Error creating tool:', error);
            } finally {
                submitBtn.removeAttribute('aria-busy');
            }
        });
    </script>
{% endblock %}
