{% extends 'base.html' %}

{% block title %}Home - HTML Tool Manager{% endblock %}

{% block content %}
    <div class="grid">
        <div class="search-container">
            <input type="search" id="search-box" name="search" placeholder="Search tools (e.g., util name:calc)">
        </div>
        <div class="sort-container">
            <select id="sort-select">
                <option value="relevance">Sort by Relevance</option>
                <option value="name_asc">Sort by Name (A-Z)</option>
                <option value="name_desc">Sort by Name (Z-A)</option>
                <option value="updated_desc">Sort by Updated (Newest)</option>
                <option value="updated_asc">Sort by Updated (Oldest)</option>
            </select>
        </div>
    </div>

    <div id="tool-list-container">
        <p aria-busy="true">Loading tools...</p>
    </div>

    <style>
        .grid {
            display: grid;
            grid-template-columns: 3fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }
    </style>

    <script>
        const searchBox = document.getElementById('search-box');
        const sortSelect = document.getElementById('sort-select');
        const container = document.getElementById('tool-list-container');
        let debounceTimer;

        async function fetchTools() {
            container.innerHTML = '<p aria-busy="true">Loading tools...</p>';
            const query = searchBox.value;
            const sort = sortSelect.value;
            
            const params = new URLSearchParams();
            if (query) params.append('q', query);
            if (sort) params.append('sort', sort);
            
            try {
                const response = await fetch(`/api/tools/?${params.toString()}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const tools = await response.json();

                if (tools.length === 0) {
                    container.innerHTML = '<p>No tools found.</p>';
                    return;
                }

                const table = document.createElement('table');
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Description</th>
                            <th>Tags</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                `;
                const tbody = table.querySelector('tbody');

                tools.forEach(tool => {
                    const tr = document.createElement('tr');

                    const nameCell = document.createElement('td');
                    nameCell.textContent = tool.name;

                    const descCell = document.createElement('td');
                    descCell.textContent = tool.description || '';

                    const tagsCell = document.createElement('td');
                    if (tool.tags && tool.tags.length > 0) {
                        tool.tags.forEach((tag, index) => {
                            const code = document.createElement('code');
                            code.textContent = tag;
                            tagsCell.appendChild(code);
                            if (index < tool.tags.length - 1) {
                                tagsCell.appendChild(document.createTextNode(' ')); // for spacing
                            }
                        });
                    }

                    const actionsCell = document.createElement('td');
                    actionsCell.innerHTML = `<div class="grid">
                        <a href="/tools/view/${tool.id}" role="button" class="secondary outline">View</a>
                        <details class="dropdown">
                            <summary role="button" class="contrast outline">⋮</summary>
                            <ul style="position: absolute; z-index: 1;">
                                <li><a href="/tools/edit/${tool.id}">Edit</a></li>
                                <li><a href="#" onclick="event.preventDefault(); deleteTool(${tool.id}, this)">Delete</a></li>
                            </ul>
                        </details>
                    </div>`;

                    tr.appendChild(nameCell);
                    tr.appendChild(descCell);
                    tr.appendChild(tagsCell);
                    tr.appendChild(actionsCell);

                    tbody.appendChild(tr);
                });

                container.innerHTML = '';
                container.appendChild(table);

            } catch (error) {
                container.innerHTML = `<p style="color: var(--pico-color-red-500);">Failed to load tools. Please try again later.</p>`;
                console.error('Error fetching tools:', error);
            }
        }

        searchBox.addEventListener('input', () => {
            clearTimeout(debounceTimer);

            const query = searchBox.value.trim();
            // クエリがコロンで終わっている場合は、まだ入力途中なのでリクエストを送らない
            if (query.endsWith(':')) {
                return;
            }

            debounceTimer = setTimeout(fetchTools, 300); // 300msのデバウンス
        });

        sortSelect.addEventListener('change', fetchTools);

        // Initial load
        fetchTools();

        function deleteTool(toolId, buttonElement) {
            if (confirm(`Are you sure you want to delete tool ID: ${toolId}?`)) {
                buttonElement.setAttribute('aria-busy', 'true');
                fetch(`/api/tools/${toolId}`, {
                    method: 'DELETE',
                })
                .then(response => {
                    if (response.ok) {
                        // Remove the row from the table
                        const row = buttonElement.closest('tr');
                        row.parentNode.removeChild(row);
                    } else {
                        alert('Failed to delete the tool.');
                        buttonElement.removeAttribute('aria-busy');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while deleting the tool.');
                    buttonElement.removeAttribute('aria-busy');
                });
            }
        }
    </script>
{% endblock %}